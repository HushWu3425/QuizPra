<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ·é¢˜ç»ƒä¹  | Practice Quiz</title>
  <!-- Favicon -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <!-- TailwindCSS 3.0+ CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Framer Motion CDN -->
  <script src="questions.js"></script>
  <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  <!-- Material Icons CDN -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: #fff;
      font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
      color: #222;
      overflow-x: hidden;
    }
    body.dark-mode {
      background: #222;
      color: #eee;
      margin-right: 0px;
    }
    .highlight {
      color: #FE1110;
    }
    .question-card {
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.06);
      border-radius: 1.5rem;
      transition: transform 0.3s cubic-bezier(.4,0,.2,1);
      background: #fff;
      width: 100%; /* Added to make question card take full width */
    }
    body.dark-mode .question-card {
      background: #333;
      color: #eee;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.3);
    }
    .question-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 8px 32px 0 rgba(254,17,16,0.10);
    }
    body.dark-mode .question-card:hover {
      box-shadow: 0 8px 32px 0 rgba(254,17,16,0.30);
    }
    .apple-scroll {
      transition: background 0.5s, box-shadow 0.5s;
    }
    .apple-scroll.scrolled {
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 16px 0 rgba(254,17,16,0.08);
    }
    body.dark-mode .apple-scroll.scrolled {
      background: rgba(51,51,51,0.95);
      box-shadow: 0 2px 16px 0 rgba(254,17,16,0.20);
    }
    .en {
      font-size: 0.75rem; /* Adjusted from 0.9rem */
      color: #888;
      font-weight: 400;
      letter-spacing: 0.04em;
    }
    body.dark-mode .en {
      color: #bbb;
    }
    .zh {
      font-size: 1.1rem; /* Adjusted from 1.35rem */
      font-weight: bold;
      letter-spacing: 0.02em;
    }
    .option-btn {
      border: 2px solid #eee;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem; /* Adjusted from 1.1rem */
      font-weight: 500;
      background: #fafafa;
      transition: border 0.2s, color 0.2s, background 0.2s;
      width: 100%; /* Make buttons full width on small screens */
      text-align: left;
    }
    body.dark-mode .option-btn {
      background: #444;
      border-color: #555;
      color: #eee;
    }
    @media (min-width: 768px) {
      .option-btn {
        width: auto; /* Auto width on larger screens */
      }
    }
    .option-btn.selected {
      border-color: #FE1110;
      color: #FE1110;
      background: #fff0f0;
    }
    body.dark-mode .option-btn.selected {
      background: #663333;
      color: #FE1110;
    }
    .option-btn.correct {
      border-color: #16a34a;
      color: #16a34a;
      background: #f0fff4;
    }
    body.dark-mode .option-btn.correct {
      background: #2a5a3a;
      color: #16a34a;
    }
    .option-btn.incorrect {
      border-color: #FE1110;
      color: #FE1110;
      background: #fff0f0;
    }
    body.dark-mode .option-btn.incorrect {
      background: #663333;
      color: #FE1110;
    }
    .explanation {
      background: #f9fafb;
      border-left: 4px solid #FE1110;
      padding: 1rem 1.5rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      color: #444;
    }
    body.dark-mode .explanation {
      background: #3a3a3a;
      color: #eee;
    }
    /* Sidebar styles */
    .sidebar {
      width: 315px;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }
    body.dark-mode .sidebar {
      background: #333;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.3);
    }
    .sidebar.open {
      transform: translateX(0);
    }
    @media (min-width: 1024px) {
      .sidebar {
        transform: translateX(0);
        position: sticky;
        top: 0;
        height: 100vh;
      }
      .sidebar-toggle-btn {
        display: none;
      }
      .main-content {
        margin-left: 280px;
      }
    }

    /* Scroll to top/bottom buttons */
    .scroll-button {
      position: fixed;
      right: 10px;
      width: 40px; /* å‡å°å°ºå¯¸ */
      height: 30px; /* å‡å°å°ºå¯¸ */
      background-color: rgb(255, 255, 255); /* æ›´æš—çš„é¢œè‰²ï¼Œæ›´é«˜é€æ˜åº¦ */
      color: rgb(192, 192, 192);
      border-radius: 6px; /* åœ†è§’çŸ©å½¢ */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px; /* è°ƒæ•´å›¾æ ‡å¤§å° */
      cursor: pointer;
      transition: background-color 0.1s, transform 0.1s;
      z-index: 1000;
    }
    body.dark-mode .scroll-button {
      background-color: #444;
      color: #bbb;
    }

    .scroll-button:hover {
      background-color: #e73f3fda; /* æ‚¬åœæ—¶é¢œè‰²æ›´æ·± */
      color: rgb(255, 255, 255);
      transform: scale(1.1);
    }

    #scroll-to-top {
      bottom: 70px;
    }

    #scroll-to-bottom {
      bottom: 30px;
    }

    /* Dark mode toggle button */
    .dark-mode-toggle {
      cursor: pointer;
      font-size: 24px;
      color: #888;
      transition: color 0.3s;
    }
    .dark-mode-toggle:hover {
      color: #FE1110;
    }
    body.dark-mode .dark-mode-toggle {
      color: #eee;
    }
    body.dark-mode .dark-mode-toggle:hover {
      color: #FE1110;
    }

    /* Random quiz button */
    #random-quiz-button {
      bottom: 110px; /* Adjust position above scroll-to-top */
    }
  </style>
</head>
<body>
  <header id="header" class="apple-scroll fixed top-0 left-0 w-full z-30 py-4 px-8 flex items-center justify-start lg:pl-80">
    <div class="flex items-center">
      <button id="sidebar-toggle" class="sidebar-toggle-btn material-icons text-gray-600 mr-4 lg:hidden">menu</button>
      <!-- Removed: åˆ·é¢˜ç»ƒä¹  and ç½‘æ˜“äº‘é£æ ¼ | Netease Cloud Style -->
    </div>
    <!-- Dark Mode Toggle -->
    <div class="absolute right-2 top-1/2 -translate-y-1/2">
      <span id="dark-mode-toggle" class="material-icons dark-mode-toggle">dark_mode</span>
    </div>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-white shadow-lg z-40 p-6 pt-4 lg:pt-4 overflow-y-auto">
      <div class="flex items-center mb-4">
        <span class="material-icons highlight mr-2">quiz</span>
        <span class="zh">åˆ·é¢˜ç»ƒä¹ </span>
        <span class="en ml-3">Practice Quiz</span>
      </div>
      
      <h3 class="zh mb-4 highlight">ç­›é€‰æ¡ä»¶ <span class="en">Filters</span></h3>
      <div class="mb-5">
        <label for="subject-filter" class="block text-gray-700 text-sm font-bold mb-2">ç§‘ç›® <span class="en">Subject</span></label>
        <select id="subject-filter" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
          <option value="all">æ‰€æœ‰ç§‘ç›® <span class="en">All Subjects</span></option>
        </select>
      </div>
            <!-- æ–°å¢çŸ¥è¯†ç‚¹ç­›é€‰å™¨ -->
      <div class="mb-5">
        <label for="knowledge-filter" class="block text-gray-700 text-sm font-bold mb-2">çŸ¥è¯†ç‚¹ <span class="en">Knowledge</span></label>
        <select id="knowledge-filter" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
          <option value="all">æ‰€æœ‰çŸ¥è¯†ç‚¹ <span class="en">All Knowledge</span></option>
        </select>
      </div>
      <!-- åˆ é™¤æœ€å¤§éš¾åº¦ç­›é€‰ç›¸å…³ä»£ç å— -->
      <div class="mb-5">
        <label for="min-error-filter" class="block text-gray-700 text-sm font-bold mb-2">æœ€å°é”™è¯¯æ¬¡æ•° <span class="en">Min Errors</span></label>
        <select id="min-error-filter" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
          <option value="0">æ‰€æœ‰ <span class="en">All</span></option>
        </select>
      </div>
      
      <!-- æ·»åŠ éšæœºæŠ½é¢˜æŒ‰é’® -->
      <div class="mb-6 flex gap-4">
        <button id="random-questions" class="flex-1 bg-orange-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
          ğŸ²éšæœºæŠ½é¢˜
        </button>
        <button id="reset-filters" class="flex-1 bg-yellow-600 hover:bg-orange-600 text-white font-bold py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
          ğŸªƒé‡ç½®ç­›é€‰
        </button>
      </div>
      
      <!-- æ·»åŠ æ—¥å†çƒ­åŠ›å›¾ -->
      <div class="mt-auto">
        <h3 class="zh mb-4 highlight">æ—¥å†çƒ­åŠ›å›¾ <span class="en">Calendar Heatmap</span></h3>
        <div id="calendar-heatmap" class="p-2 bg-gray-50 rounded-lg ">
          <!-- æ—¥å†çƒ­åŠ›å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 pb-12 px-4 w-full mx-auto lg:ml-80 mt-10"> 
      <!-- æ–°å¢é¡¶éƒ¨ç­›é€‰æ  -->
      <div class="flex justify-between items-center mb-6 mt-4 ml-4 mr-2"> 
        <div class="flex-1 mr-4">
          <label for="top-subject-filter" class="block text-gray text-sm font-bold mb-2">ç§‘ç›®</label>
           <select id="top-subject-filter" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
            <option value="all">æ‰€æœ‰ç§‘ç›®</option>
          </select>
        </div>
        <div class="flex-1 mr-4">
          <label for="top-error-filter" class="block text-gray text-sm font-bold mb-2">é”™è¯¯æ¬¡æ•°</label>
          <select id="top-error-filter" class="block appearance-none w-full bg-gray-200 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
            <option value="0">æ‰€æœ‰</option>
          </select>
        </div>
        <div class="flex-0.5 text-right">
        <button id="top-reset-filter" class="mt-7 bg-gray-200 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded font-medium">
          â™»ï¸
        </button>
      </div>
      </div>

      <div id="question-container"></div>
    </main><!-- Modified: Removed max-w-4xl, added w-full -->
  </div>

  <!-- Random Quiz Button -->
  <div id="text-summary-exercise-button" class="scroll-button material-icons" style="bottom: 150px;">description</div>
  <div id="random-quiz-button" class="scroll-button material-icons">casino</div>

  <!-- Scroll to Top/Bottom Buttons -->
  <div id="scroll-to-top" class="scroll-button material-icons">keyboard_arrow_up</div>
  <div id="scroll-to-bottom" class="scroll-button material-icons">keyboard_arrow_down</div>

  <script>
    // Appleå®˜ç½‘é£æ ¼æ»šåŠ¨åŠ¨æ•ˆ
    window.addEventListener('scroll', function() {
      const header = document.getElementById('header');
      if(window.scrollY > 10) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle');
    const mainContent = document.querySelector('.main-content');
    const header = document.getElementById('header');

    sidebarToggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      if (sidebar.classList.contains('open')) {
        // On mobile, when sidebar opens, push main content to the right
        if (window.innerWidth < 1024) {
          mainContent.style.transform = 'translateX(280px)';
          header.style.transform = 'translateX(280px)';
        }
      } else {
        if (window.innerWidth < 1024) {
          mainContent.style.transform = 'translateX(0)';
          header.style.transform = 'translateX(0)';
        }
      }
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (event) => {
      if (window.innerWidth < 1024 && sidebar.classList.contains('open') &&
          !sidebar.contains(event.target) && !sidebarToggleBtn.contains(event.target)) {
        sidebar.classList.remove('open');
        mainContent.style.transform = 'translateX(0)';
        header.style.transform = 'translateX(0)';
      }
    });

    document.getElementById('top-reset-filter').addEventListener('click', () => {
      // é‡ç½®é¡¶éƒ¨ç­›é€‰
      document.getElementById('top-subject-filter').value = 'all';
      document.getElementById('top-error-filter').value = '0';
      
      // é‡ç½®ä¾§è¾¹æ ç­›é€‰ï¼ˆå¦‚æœéœ€è¦ï¼‰
      // document.getElementById('subject-filter').value = 'all';
      // document.getElementById('min-error-filter').value = '0';
      
      // é‡æ–°ç­›é€‰
      filterAndRenderQuestions();
    });
    // Adjust main content and header margin on resize for desktop view
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024) {
        sidebar.classList.remove('open'); // Ensure sidebar is open on desktop
        mainContent.style.transform = 'translateX(0)';
        header.style.transform = 'translateX(0)';
      }
    });

    let allQuestions = [];
    let filteredQuestions = [];
    // æ·»åŠ æ—¥å†çƒ­åŠ›å›¾ç›¸å…³å˜é‡
    let currentMonthOffset = 0; // å½“å‰æœˆä»½åç§»é‡ï¼ˆ0ä¸ºå½“å‰æœˆï¼Œ-1ä¸ºä¸Šæœˆï¼Œ1ä¸ºä¸‹æœˆï¼‰

    // ç›´æ¥ä½¿ç”¨ questions.js ä¸­çš„å˜é‡
    allQuestions = questions;
    populateFilters();
    filterAndRenderQuestions();
    
    // æ·»åŠ æ—¥å†çƒ­åŠ›å›¾ç›¸å…³å‡½æ•°
    function generateCalendarHeatmap() {
      // ç»Ÿè®¡æ¯å¤©çš„é”™é¢˜æ•°é‡
      const dateCountMap = {};
      
      allQuestions.forEach(q => {
        if (q.lasttime) {
          // æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
          const date = q.lasttime.split('T')[0];
          dateCountMap[date] = (dateCountMap[date] || 0) + 1;
        }
      });
      
      // ç”Ÿæˆæ—¥å†çƒ­åŠ›å›¾
      const heatmapContainer = document.getElementById('calendar-heatmap');
      heatmapContainer.innerHTML = '';
      
      // åˆ›å»ºæ ‡é¢˜å’Œå¯¼èˆªæŒ‰é’®
      const titleContainer = document.createElement('div');
      titleContainer.className = 'flex justify-between items-center mb-2';
      
      const prevButton = document.createElement('button');
      prevButton.className = 'material-icons text-sm p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600';
      prevButton.textContent = 'arrow_back_ios';
      prevButton.onclick = () => {
        currentMonthOffset--;
        generateCalendarHeatmap();
      };
      
      const title = document.createElement('div');
      title.className = 'text-center font-bold';
      const now = new Date();
      const targetMonth = new Date(now.getFullYear(), now.getMonth() + currentMonthOffset, 1);
      title.textContent = `${targetMonth.getFullYear()}å¹´${targetMonth.getMonth() + 1}æœˆ`;
      
      const nextButton = document.createElement('button');
      nextButton.className = 'material-icons text-sm p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600';
      nextButton.textContent = 'arrow_forward_ios';
      nextButton.onclick = () => {
        currentMonthOffset++;
        generateCalendarHeatmap();
      };
      
      titleContainer.appendChild(prevButton);
      titleContainer.appendChild(title);
      titleContainer.appendChild(nextButton);
      heatmapContainer.appendChild(titleContainer);
      
      // åˆ›å»ºæ—¥å†ç½‘æ ¼
      const calendarGrid = document.createElement('div');
      calendarGrid.className = 'grid grid-cols-7 gap-1';
      
      // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      weekdays.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'text-center text-xs p-1';
        dayElement.textContent = day;
        calendarGrid.appendChild(dayElement);
      });
      
      // è·å–ç›®æ ‡æœˆä»½çš„æ—¥æœŸèŒƒå›´
      const year = targetMonth.getFullYear();
      const month = targetMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      // å¡«å……æ—¥æœŸç½‘æ ¼
      // å…ˆå¡«å……æœˆåˆçš„ç©ºä½
      for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyElement = document.createElement('div');
        emptyElement.className = 'text-center text-xs p-1 rounded';
        calendarGrid.appendChild(emptyElement);
      }
      
      // å¡«å……å½“æœˆæ—¥æœŸ
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const currentDate = new Date(year, month, day);
        const dateString = currentDate.toISOString().split('T')[0];
        const count = dateCountMap[dateString] || 0;
        
        const dateElement = document.createElement('div');
        dateElement.className = 'text-center text-xs p-1 rounded cursor-pointer hover:opacity-75 transition-opacity';
        dateElement.textContent = day;
        dateElement.dataset.date = dateString;
        
        // æ ¹æ®é”™é¢˜æ•°é‡è®¾ç½®ä¸åŒçš„é¢œè‰²æ·±åº¦
        if (count === 0) {
          dateElement.style.backgroundColor = '#e5e7eb';
          dateElement.classList.add('dark:bg-gray-600', 'dark:text-gray-400');
        } else if (count < 2) {
          dateElement.style.backgroundColor = '#fef3c7';
          dateElement.style.color = '#92400e';
          dateElement.classList.add('dark:bg-yellow-700', 'dark:text-yellow-100');
        } else if (count < 4) {
          dateElement.style.backgroundColor = '#fcd34d';
          dateElement.style.color = '#92400e';
          dateElement.classList.add('dark:bg-yellow-600', 'dark:text-yellow-100');
        } else {
          dateElement.style.backgroundColor = '#f59e0b';
          dateElement.style.color = '#ffffff';
          dateElement.classList.add('dark:bg-yellow-500');
        }
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        dateElement.addEventListener('click', () => {
          // é«˜äº®é€‰ä¸­çš„æ—¥æœŸ
          document.querySelectorAll('#calendar-heatmap .grid > div').forEach(el => {
            el.classList.remove('ring-2', 'ring-red-500');
          });
          dateElement.classList.add('ring-2', 'ring-red-500');
          
          // ç­›é€‰å¹¶æ˜¾ç¤ºè¯¥æ—¥æœŸçš„é¢˜ç›®
          filterQuestionsByDate(dateString);
        });
        
        calendarGrid.appendChild(dateElement);
      }
      
      heatmapContainer.appendChild(calendarGrid);
      
      // æ·»åŠ å›¾ä¾‹
      const legend = document.createElement('div');
      legend.className = 'flex justify-between text-xs mt-2 dark:text-gray-300';
      legend.innerHTML = `
        <span>å°‘</span>
        <div class="flex">
          <div class="w-3 h-3 bg-gray-200 mx-1 dark:bg-gray-600"></div>
          <div class="w-3 h-3 bg-yellow-100 mx-1 dark:bg-yellow-700"></div>
          <div class="w-3 h-3 bg-yellow-300 mx-1 dark:bg-yellow-600"></div>
          <div class="w-3 h-3 bg-yellow-500 mx-1 dark:bg-yellow-500"></div>
        </div>
        <span>å¤š</span>
      `;
      heatmapContainer.appendChild(legend);
    }
    
    // æ ¹æ®æ—¥æœŸç­›é€‰é¢˜ç›®
    function filterQuestionsByDate(date) {
      filteredQuestions = allQuestions.filter(q => {
        if (!q.lasttime) return false;
        return q.lasttime.split('T')[0] === date;
      });
      
      renderQuestions(filteredQuestions);
    }
    
    // ä¿®æ”¹ populateFilters å‡½æ•°ï¼Œåœ¨æœ«å°¾æ·»åŠ ç”Ÿæˆæ—¥å†çƒ­åŠ›å›¾çš„è°ƒç”¨
    function populateFilters() {
      const subjectFilter = document.getElementById('subject-filter');
      const minErrorFilter = document.getElementById('min-error-filter');
      const knowledgeFilter = document.getElementById('knowledge-filter'); // è·å–çŸ¥è¯†ç‚¹ç­›é€‰å™¨
      const subjects = new Set();
      const knowledges = new Set(); // ç”¨äºå­˜å‚¨æ‰€æœ‰å”¯ä¸€çš„çŸ¥è¯†ç‚¹
      let maxErrorNumber = 0;

      allQuestions.forEach(q => {
        subjects.add(q.subject);
        if (q.knowledge) { // ç¡®ä¿çŸ¥è¯†ç‚¹å­˜åœ¨
          knowledges.add(q.knowledge);
        }
        if (q.error_number > maxErrorNumber) {
          maxErrorNumber = q.error_number;
        }
      });

      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectFilter.appendChild(option);
      });

      // Populate knowledge filter
      knowledges.forEach(knowledge => {
        const option = document.createElement('option');
        option.value = knowledge;
        option.textContent = knowledge;
        knowledgeFilter.appendChild(option);
      });

      // Populate min error filter
      for (let i = 0; i <= maxErrorNumber; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        minErrorFilter.appendChild(option);
      }
      
      // ç”Ÿæˆæ—¥å†çƒ­åŠ›å›¾
      generateCalendarHeatmap();
    }

    function filterAndRenderQuestions() {
      // è·å–é¡¶éƒ¨ç­›é€‰æ§ä»¶å€¼
      const topSubject = document.getElementById('top-subject-filter').value;
      const topMinError = parseInt(document.getElementById('top-error-filter').value);
      
      // è·å–ä¾§è¾¹æ ç­›é€‰æ§ä»¶å€¼
      const sidebarSubject = document.getElementById('subject-filter').value;
      const selectedKnowledge = document.getElementById('knowledge-filter').value;
      const sidebarMinError = parseInt(document.getElementById('min-error-filter').value);

      // åˆå¹¶ç­›é€‰æ¡ä»¶ï¼šé¡¶éƒ¨ç­›é€‰ä¼˜å…ˆ
      const finalSubject = topSubject !== 'all' ? topSubject : sidebarSubject;
      const finalMinError = topMinError !== 0 ? topMinError : sidebarMinError;

      filteredQuestions = allQuestions.filter(q => {
        const subjectMatch = finalSubject === 'all' || q.subject === finalSubject;
        const knowledgeMatch = selectedKnowledge === 'all' || q.knowledge === selectedKnowledge;
        const errorMatch = q.error_number >= finalMinError;
        
        return subjectMatch && knowledgeMatch && errorMatch;
      });
      
      renderQuestions(filteredQuestions);
    }
    
    function renderQuestions(questionsToRender) {
      const questionContainer = document.getElementById('question-container');
      let allQuestionsHtml = '';

      if (questionsToRender.length === 0) {
        allQuestionsHtml = '<p class="text-center text-gray-500 text-xl mt-10">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ã€‚<br><span class="en">No questions found matching the criteria.</span></p>';
      } else {
        questionsToRender.forEach((q) => {
          let questionHtml = `<div class='question-card p-8 mb-6'>
            <div class='zh mb-2'>Q${q.question_id}ï¼š${q.content}</div> 
            <div class='en mb-4'>ç§‘ç›® Subject: ${q.subject} | éš¾åº¦ Difficulty: ${q.difficulty} | é”™è¯¯æ¬¡æ•° Errors: ${q.error_number} | æœ€è¿‘é”™è¯¯ Last Error: ${q.lasttime || 'N/A'}</div>`;
          ['A','B','C','D'].forEach(opt => {
            questionHtml += `<button class='option-btn' data-question-id='${q.question_id}' data-opt='${opt}'>${opt}. ${q['option_' + opt]}</button><br/>`;
          });
          questionHtml += `<div id='explanation-${q.question_id}' class='explanation hidden'></div>`;
          questionHtml += `</div>`;
          allQuestionsHtml += questionHtml;
        });
      }
      questionContainer.innerHTML = allQuestionsHtml;

      // Re-attach event listeners for newly rendered buttons
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.onclick = function() {
          const questionId = this.getAttribute('data-question-id');
          const selectedOption = this.getAttribute('data-opt');
          const currentQuestion = allQuestions.find(q => q.question_id == questionId);

          // Remove selected/correct/incorrect classes from all options of this question
          document.querySelectorAll(`.option-btn[data-question-id='${questionId}']`).forEach(b => b.classList.remove('selected','correct','incorrect'));

          this.classList.add('selected');
          const explanationDiv = document.getElementById(`explanation-${questionId}`);
          explanationDiv.classList.remove('hidden');

          if(selectedOption === currentQuestion.answer) {
            this.classList.add('correct');
            explanationDiv.innerHTML = `<span class="highlight">âœ” æ­£ç¡®ï¼</span> ${currentQuestion.explanation}`;
          } else {
            this.classList.add('incorrect');
            explanationDiv.innerHTML = `<span class="highlight">âœ— é”™è¯¯ï¼</span> æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${currentQuestion.answer}ã€‚ ${currentQuestion.explanation}`;
          }
        };
      });
    }

    // Add event listeners to filters
    document.getElementById('subject-filter').addEventListener('change', filterAndRenderQuestions);
    document.getElementById('knowledge-filter').addEventListener('change', filterAndRenderQuestions); // æ·»åŠ çŸ¥è¯†ç‚¹ç­›é€‰å™¨çš„äº‹ä»¶ç›‘å¬
    // åˆ é™¤ difficulty-filter ç›¸å…³äº‹ä»¶ç›‘å¬
    document.getElementById('min-error-filter').addEventListener('change', filterAndRenderQuestions);
    
    // æ·»åŠ éšæœºæŠ½é¢˜åŠŸèƒ½
    document.getElementById('random-questions').addEventListener('click', function() {
    // ä»æ‰€æœ‰é¢˜ç›®ä¸­éšæœºæŠ½å–10é“
    const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
    const random10 = shuffled.slice(0, 10);
    
    // æ¸²æŸ“éšæœºé¢˜ç›®
    renderQuestions(random10);
    });

    // æ–°å¢æ–‡æœ¬æ€»ç»“ç»ƒä¹ æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('text-summary-exercise-button').addEventListener('click', function() {
      window.location.href = 'text-summary-exercise.html';
    });

    // æ–°å¢éª°å­æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('random-quiz-button').addEventListener('click', function() {
      const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
      const random10 = shuffled.slice(0, 10);
      renderQuestions(random10);
    });
    
    // é‡ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬
    document.getElementById('reset-filters').addEventListener('click', function() {
      // é‡ç½®æ‰€æœ‰ç­›é€‰æ§ä»¶
      document.getElementById('subject-filter').value = 'all';
      document.getElementById('min-error-filter').value = '0';
      document.getElementById('knowledge-filter').value = 'all'; // é‡ç½®çŸ¥è¯†ç‚¹ç­›é€‰å™¨
      
      // é‡ç½®æœˆä»½åç§»
      currentMonthOffset = 0;
      
      // é‡æ–°ç­›é€‰å¹¶æ¸²æŸ“é¢˜ç›®
      filterAndRenderQuestions();
      
      // é‡æ–°ç”Ÿæˆæ—¥å†çƒ­åŠ›å›¾
      generateCalendarHeatmap();
    });

    
    

    // Initial sidebar state for desktop
    if (window.innerWidth >= 1024) {
      sidebar.classList.add('open');
    }

    // Scroll to top/bottom functionality
    document.getElementById('scroll-to-top').addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('scroll-to-bottom').addEventListener('click', () => {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    // Dark Mode Toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const body = document.body;

    // Check for saved dark mode preference
    if (localStorage.getItem('darkMode') === 'enabled') {
      body.classList.add('dark-mode');
      darkModeToggle.textContent = 'light_mode';
    }

    darkModeToggle.addEventListener('click', () => {
      if (body.classList.contains('dark-mode')) {
        body.classList.remove('dark-mode');
        darkModeToggle.textContent = 'dark_mode';
        localStorage.setItem('darkMode', 'disabled');
      } else {
        body.classList.add('dark-mode');
        darkModeToggle.textContent = 'light_mode';
        localStorage.setItem('darkMode', 'enabled');
      }
    });
  </script>
</body>
</html>



